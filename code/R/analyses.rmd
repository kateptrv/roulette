---
output:
  reprex::reprex_document:
    venue: "gh"
    advertise: FALSE
    session_info: TRUE
    style: TRUE
    comment: "#;-)"
    tidyverse_quiet: FALSE
    std_out_err: TRUE
knit: reprex::reprex_render
---

# Setup

```{r}
if(!suppressWarnings(require(pacman))){install.packages("pacman");library("pacman")}
p_load(tidyverse, tidyr, dplyr, ggplot2, stats, sjPlot, readr, ggpubr, patchwork, lubridate, ggthemr, ggdist, ggpubr, showtext, usethis, data.table, png, grid, purrr, ggimage, osfr, jsonlite, lme4, janitor, brms)
```

```{r}
data_full <- read_csv("../../data/data_clean_full.csv") |>
  filter(comp_tries_to_pass <= 2) |>
  group_by(prolific_pid) |>
  filter(max(trial) == 24) |>
  mutate(n_hot_choice = sum(choice_hot == "Chose Hot")) |>
  ungroup()

data_slim <- read_csv("../../data/data_clean_slim.csv") |>
  filter(comp_tries_to_pass <= 2) |>
  group_by(prolific_pid) |>
  mutate(n_hot_choice = sum(choice_hot == "Chose Hot")) |>
  ungroup()

data_mc_full <- read_csv("../../data/data_clean_mc_full.csv") |>
  filter(comp_tries_to_pass <= 2) |>
  group_by(prolific_pid) |>
  mutate(n_hot_choice = sum(choice_hot == "Chose Hot")) |>
  ungroup()
```

```{r}
ggthemr("fresh", type = "outer")
pal_com <- c(
  "Chose Hot" = "#8B1E3F",  
  "Chose Non-Hot"     = "#D16C7C"  
)

pal_om <- c(
  "Chose Hot" = "#1F4E79",  
  "Chose Non-Hot"     = "#7FA6C9"   
)

pal_combined <- c(
"#8B1E3F", "#1F4E79",  "#D16C7C", "#7FA6C9")
```

# Sample characteristics 

## Study 1a

```{r}
data_full |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  # 89 collected, 75 with 2 or fewer tries on the comprehension check
  ungroup() |>
  psych::describe() 

data_full |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(gender)

data_full |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(race)

data_full |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(ethnicity)

data_full |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(gamble_freq_12mo)


```

## Study 1b

```{r}
data_slim |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  # 72 collected, 54 with 2 or fewer tries on the comprehension check
  ungroup() |>
  psych::describe()

data_slim |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(gender)

data_slim |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(race)

data_slim |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(ethnicity)

data_slim |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(gamble_freq_12mo)

```

## Study 2

```{r}
data_mc_full |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  # 72 collected, 54 with 2 or fewer tries on the comprehension check
  ungroup() |>
  psych::describe()

# note: prolific screeners set for people who report video games/computer games as hobbies
data_mc_full |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(gender)

data_mc_full |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(race)

data_mc_full |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(ethnicity)

data_mc_full |>
  group_by(prolific_pid) |>
  select(prolific_pid, feedback:n_hot_choice) |>
  distinct() |>
  ungroup() |>
  tabyl(gamble_freq_12mo)

```

# Study 1a analyses

```{r}
data_full |>
  ggplot(aes(x = win_status, y = regret_chosen, color = win_status, fill = win_status)) +
  geom_point(aes(alpha = 0.2), position = position_jitter(w = 0.1)) +
  stat_summary(
  fun.data = mean_cl_boot, conf.int = .95, B = 5000,
  geom = "pointrange", linewidth = 1, size = 1,
  shape = 21
) +
  labs(x = "Won?",
     y = "Regret") +
  facet_wrap(~choice_hot)
```

```{r}
data_full |>
  filter(win_status == "Lost" & hot_set_size > 0) |>
  ggplot(aes(x = outcome_rel_to_hot, y = regret_notchosen_winner, color = outcome_rel_to_hot, fill = outcome_rel_to_hot)) +
  stat_summary(
  fun.data = mean_cl_boot, conf.int = .95, B = 5000,
  geom = "pointrange", linewidth = 1, size = 1,
  shape = 21
) +
  labs(x = "Type of winning number",
     y = "Regret not chosen") +
  facet_wrap(~hot_set_size, nrow = 1) 
```

```{r}

p1 <- data_mc_full |>
  filter(win_status == "Lost" & outcome_rel_to_hot == "hot_win_number") |>
  ggplot(aes(x = as.factor(hot_set_size), y = regret_chosen, color = choice_hot, fill = choice_hot)) +
  stat_summary(
  fun.data = mean_cl_boot, conf.int = .95, B = 5000,
  geom = "pointrange", linewidth = 1, size = 1,
  shape = 21
) +
  ylim(0,100) +
  labs(x = "N of hot numbers",
     y = "Regret",
     title = "Commission regret",
     subtitle = "Hot number won") +
  scale_color_manual(values = pal_com, name = "Participant's choice:") +
  scale_fill_manual(values = pal_com, name = "Participant's choice:") +
  theme(legend.position = "bottom") +
  facet_wrap(~choice_hot)

p2 <- data_mc_full |>
  filter(win_status == "Lost" & outcome_rel_to_hot == "hot_win_number") |>
  ggplot(aes(x = as.factor(hot_set_size), y = regret_notchosen_winner, color = choice_hot, fill = choice_hot)) +
  stat_summary(
  fun.data = mean_cl_boot, conf.int = .95, B = 5000,
  geom = "pointrange", linewidth = 1, size = 1,
  shape = 21
) +
  ylim(0,100) +
  labs(x = "N of hot numbers",
     y = "Regret",
     title = "Omission regret",
     subtitle = "Hot number won") +
  scale_color_manual(values = pal_om, name = "Participant's choice:") +
  scale_fill_manual(values = pal_om, name = "Participant's choice:") +
  theme(legend.position = "bottom") +
  facet_wrap(~choice_hot)

p1 + p2 

```

```{r}
p1 <- data_mc_full |>
  filter(win_status == "Lost" & outcome_rel_to_hot == "hot_win_number") |>
  group_by(prolific_pid) |>
  mutate(regret_chosen_pmc = regret_chosen - mean(regret_chosen, na.rm = TRUE)) |>
  ungroup() |>
  ggplot(aes(x = as.factor(hot_set_size), y = regret_chosen_pmc, color = choice_hot, fill = choice_hot)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  stat_summary(
  fun.data = mean_cl_boot, conf.int = .95, B = 5000,
  geom = "pointrange", linewidth = 1, size = 1,
  shape = 21
) +
  ylim(-10,20) +
  labs(x = "N of hot numbers",
     y = "Regret (person-centered)",
     title = "Commission regret",
     subtitle = "Hot number won") +
  scale_color_manual(values = pal_com, name = "Participant's choice:") +
  scale_fill_manual(values = pal_com, name = "Participant's choice:") +
  theme(legend.position = "bottom") +
  facet_wrap(~choice_hot)

p2 <- data_mc_full |>
  filter(win_status == "Lost" & outcome_rel_to_hot == "hot_win_number") |>
  group_by(prolific_pid) |>
  mutate(regret_notchosen_winner_pmc = regret_notchosen_winner - mean(regret_notchosen_winner, na.rm = TRUE)) |>
  ungroup() |>
  ggplot(aes(x = as.factor(hot_set_size), y = regret_notchosen_winner_pmc, color = choice_hot, fill = choice_hot)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  stat_summary(
  fun.data = mean_cl_boot, conf.int = .95, B = 5000,
  geom = "pointrange", linewidth = 1, size = 1,
  shape = 21
) +
  ylim(-10,20) +
  labs(x = "N of hot numbers",
     y = "Regret (person-centered)",
     title = "Omission regret",
     subtitle = "Hot number won") +
  scale_color_manual(values = pal_om, name = "Participant's choice:") +
  scale_fill_manual(values = pal_om, name = "Participant's choice:") +
  theme(legend.position = "bottom") +
  facet_wrap(~choice_hot)

p1 + p2 
```

```{r}
data_slim |>
  filter(win_status == "Lost" & outcome_rel_to_hot == "hot_win_number") |>
  ggplot(aes(x = as.factor(hot_set_size), y = regret_notchosen_winner, color = as.factor(hot_set_size), fill = as.factor(hot_set_size))) +
  geom_point() +
  stat_summary(
  fun.data = mean_cl_boot, conf.int = .95, B = 5000,
  geom = "pointrange", linewidth = 1, size = 1,
  shape = 21
) +
  labs(x = "Number of hot numbers",
     y = "Regret non-chosen") +
  facet_wrap(~choice_hot)
```

```{r}
data_lost <- data_mc_full |>
  filter(win_status == "Lost" & outcome_rel_to_hot == "hot_win_number")

model1 <- lmer(regret_notchosen_winner ~ choice_hot * hot_set_size + (1|prolific_pid), data = data_lost)
tab_model(model1)
sjPlot::plot_model(model1, type = "int")

model2 <- lmer(regret_chosen ~  choice_hot * hot_set_size + (1|prolific_pid), data = data_lost)
tab_model(model2)
sjPlot::plot_model(model2, type = "int")

```

```{r}
data_full |> 
  filter(win_status == "Lost") |>
  mutate(distance = abs(chosen_number - winner_number)) |>
  ggplot(aes(x = distance, y = regret_chosen)) +
  geom_point(aes(alpha = 0.2)) +
  geom_smooth(method = "lm", se = TRUE, linewidth = 1) +
  labs(x = "Distance from Winner",
     y = "Regret about choosing") +
  stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top")

```

```{r}
data_slim |> 
  filter(win_status == "Lost") |>
  mutate(distance = abs(chosen_number - winner_number)) |>
  ggplot(aes(x = distance, y = regret_notchosen_winner)) +
  geom_point(aes(alpha = 0.2)) +
  geom_smooth(method = "lm", se = TRUE, linewidth = 1) +
  labs(x = "Distance from Winner",
     y = "Regret about not choosing") + 
  stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top")
```

```{r}
data_slim |>
  filter(win_status == "Lost" & outcome_rel_to_hot == "hot_win_number") |>
  filter(choice_hot == "Chose Hot") |>
  ggplot(aes(x = regret_chosen, y = regret_notchosen_winner)) +
  geom_point(aes(alpha = 0.2)) +
  geom_smooth(method = "lm", se = TRUE, linewidth = 1) +
  labs(x = "Regret about choosing losing",
     y = "Regret about not choosing winning") +
  stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top") 

data_slim |>
  filter(win_status == "Lost" & outcome_rel_to_hot == "hot_win_number") |>
  filter(choice_hot == "Chose Non-Hot") |>
  ggplot(aes(x = regret_chosen, y = regret_notchosen_winner)) +
  geom_point(aes(alpha = 0.2)) +
  geom_smooth(method = "lm", se = TRUE, linewidth = 1) +
  labs(x = "Regret about choosing losing",
     y = "Regret about not choosing winning") +
  stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top") 
```

```{r}
data_slim |>
  filter(win_status == "Lost" & hot_set_size > 0) |>
  ggplot(aes(x = outcome_rel_to_hot, y = regret_notchosen_winner, color = outcome_rel_to_hot, fill = outcome_rel_to_hot)) +
  stat_summary(
  fun.data = mean_cl_boot, conf.int = .95, B = 5000,
  geom = "pointrange", linewidth = 1, ize = 1,
  shape = 21
) +
  facet_wrap(~hot_set_size, nrow = 1)
```

```{r}
data_full |>
  filter(win_status == "Lost" & outcome_rel_to_hot == "hot_win_number") |>
  pivot_longer(cols = c(regret_chosen, regret_notchosen_winner), names_to = "regret_type", values_to = "regret_value") |>
  ggplot(aes(x = choice_hot, y = regret_value, color = interaction(regret_type, choice_hot), fill = interaction(regret_type, choice_hot))) +
  stat_summary(
  fun.data = mean_cl_boot, conf.int = .95, B = 5000,
  geom = "pointrange", linewidth = 1, size = 1,
  shape = 21,
  position = position_dodge(width = 0.3)
) +
  ylim(0,100) +
  labs(x = "N of hot numbers",
     y = "Regret",
     subtitle = "Hot number won") +
  scale_color_manual(values = pal_combined, name = "Participant's choice:") +
  scale_fill_manual(values = pal_combined, name = "Participant's choice:") +
  theme(legend.position = "bottom") +
  facet_wrap(~ hot_set_size, nrow = 1)
```

```{r}
data_full |>
  filter(win_status == "Lost" & outcome_rel_to_hot == "hot_win_number") |>
  pivot_longer(cols = c(regret_chosen, regret_notchosen_winner), names_to = "regret_type", values_to = "regret_value") |>
  group_by(prolific_pid) |>
  mutate(regret_pmc = regret_value - mean(regret_value, na.rm = TRUE)) |>
  ungroup() |>
  ggplot(aes(x = choice_hot, y = regret_pmc, color = interaction(regret_type, choice_hot), fill = interaction(regret_type, choice_hot))) +
  stat_summary(
  fun.data = mean_cl_boot, conf.int = .95, B = 5000,
  geom = "pointrange", linewidth = 1, size = 1,
  shape = 21,
  position = position_dodge(width = 0.3)
) +
  labs(x = "N of hot numbers",
     y = "Regret (person-centered)",
     subtitle = "Study 2a") +
  scale_color_manual(values = pal_combined, name = "Participant's choice:") +
  scale_fill_manual(values = pal_combined, name = "Participant's choice:") +
  theme(legend.position = "bottom") +
  facet_wrap(~ hot_set_size, nrow = 1)
```

```{r}
data_model <- data_full |>
  filter(win_status == "Lost" & outcome_rel_to_hot == "hot_win_number") |>
  pivot_longer(cols = c(regret_chosen, regret_notchosen_winner), names_to = "regret_type", values_to = "regret_value") |>
  mutate(regret_type = case_when(regret_type == "regret_chosen" ~ "Commission",
                                 regret_type == "regret_notchosen_winner" ~ "Omission")) |>
  group_by(prolific_pid) |>
  mutate(regret_pmc = regret_value - mean(regret_value, na.rm = TRUE)) |>
  ungroup() |>
  mutate(hot_set_size = factor(hot_set_size))

model1 <- bf(
  regret_pmc ~ regret_type * choice_hot * hot_set_size +
    (1 | prolific_pid)
)

model1_fit <- brm(
  formula = model1,
  data = data_model,
  family = student,
  chains = 4,
  cores = 4,
  iter = 4000,
  warmup = 1000,
  seed = 1234
)

print(model1_fit)
pp_check(model1_fit)
tab_model(model1_fit)

```

```{r}
ce <- conditional_effects(
  model1_fit,
  effects = "hot_set_size:choice_hot",
  conditions = data.frame(regret_type = c("Commission", "Omission")),
  re_formula = NA,
  prob = 0.95
)

plot(ce, plot = FALSE)[[1]] +
  ggplot2::labs(
    x = "Hot set size",
    y = "Predicted regret (person-centered)",
    color = "Choice",
    fill  = "Choice"
  )
```

```{r}
# session info
sessionInfo() |>
  capture.output("analyses_session_info.txt")
```
