---
output:
  reprex::reprex_document:
    venue: "gh"
    advertise: FALSE
    session_info: TRUE
    style: TRUE
    comment: "#;-)"
    tidyverse_quiet: FALSE
    std_out_err: TRUE
knit: reprex::reprex_render
---

```{r}
if(!suppressWarnings(require(pacman))){install.packages("pacman");library("pacman")}
p_load(tidyverse, tidyr, dplyr, ggplot2, stats, sjPlot, readr, ggpubr, patchwork, lubridate, ggthemr, ggdist, ggpubr, showtext, usethis, data.table, png, grid, purrr, ggimage, osfr, jsonlite)
```

```{r}
data_raw <- read_csv("../../data/data_raw.csv")
```

```{r}
comp_attempts <- data_raw |>
  filter(trial_type == "survey-multi-choice") |>
  group_by(prolific_pid) |>
  summarise(
    comp_attempts = n(),
    comp_passed = any(correct %in% TRUE),
    # "tries it took to get it right" = index of first TRUE
    comp_tries_to_pass = {
      idx <- which(correct %in% TRUE)
      if (length(idx) == 0) NA_integer_ else min(idx)
    },
    .groups = "drop"
  )
```

```{r}
safe_fromJSON <- function(x) {
  tryCatch(fromJSON(x), error = function(e) NULL)
}

demographics <- data_raw |>
  filter(trial_type == "survey-html-form") |>
  transmute(
    prolific_pid,
    resp = map(response, safe_fromJSON)
  ) |>
  filter(map_lgl(resp, ~ !is.null(.x) && (("age" %in% names(.x)) || ("gamble_freq_12mo" %in% names(.x)) || ("hot_reliance" %in% names(.x))))) |>
  group_by(prolific_pid) |>
  slice_tail(n = 1) |>   # if multiple, keep the last one
  ungroup() |>
  transmute(
    prolific_pid,
    feedback         = map_chr(resp, ~ .x$feedback %||% NA_character_),
    age              = map_int(resp, ~ as.integer(.x$age %||% NA_integer_)),
    gamble_freq_12mo  = map_chr(resp, ~ .x$gamble_freq_12mo %||% NA_character_),
    hot_reliance      = map_chr(resp, ~ .x$hot_reliance %||% NA_character_) |> as.integer(),
    race             = map_chr(resp, ~ .x$race %||% NA_character_),
    gender           = map_chr(resp, ~ .x$gender %||% NA_character_),
    ethnicity         = map_chr(resp, ~ .x$ethnicity %||% NA_character_)
  )
```

# Roulette

## Full (24 trials)

### Processing

```{r}
data_clean_full <- data_raw |>
  group_by(prolific_pid) |>
  mutate(max_trial = max(trial_index)) |>
  ungroup() |>
  filter(max_trial >= 50) |>
  filter(trial_type != "instructions" & trial_type != "survey-multi-choice") |>
  select(prolific_pid, balance, choice, outcome, response, banner, win_status, hot_set_size, hot_numbers, outcome_rel_to_hot, trial_type, rt) |>
  group_by(prolific_pid) |>
  mutate(response = lead(response, 2)) |>
  ungroup() |>
  filter(!(is.na(balance) & is.na(hot_numbers))) |>
  filter(!(is.na(balance))) |>
  group_by(prolific_pid) |>
  mutate(trial = row_number()) |>
  ungroup() %>% 
  mutate(choice_hot = map2_lgl(choice, hot_numbers, ~ {
    hot_nums <- fromJSON(.y)
    .x %in% hot_nums
  })) %>%
  mutate(choice_hot = case_when(choice_hot == TRUE ~ "Chose Hot", TRUE ~ "Chose Non-Hot")) |>
  select(-c(trial_type, rt, hot_numbers)) %>% 
  mutate(
    response_parsed = map(response, ~ fromJSON(.x))
  ) %>%
  mutate(
    regret_chosen = map_dbl(response_parsed, ~ .x$regret_chosen %||% NA_real_),
    regret_notchosen_winner = map_dbl(response_parsed, ~ .x$regret_not_winner %||% NA_real_),
    regret_notchosen_hot_loser = map_dbl(response_parsed, ~ .x$regret_not_hot_probe %||% NA_real_)
  ) %>%
  select(-c(response, response_parsed)) |>
  rename(
    winner_number = outcome,
    chosen_number = choice,
    banner_yn = banner
  ) |>
  relocate(trial, .after = prolific_pid) |>
  mutate(
    win_status = ifelse(win_status == 0, "Lost", "Won"),
    banner_yn = ifelse(banner_yn == 0, "No Banner", "Banner")
  ) |>
  left_join(comp_attempts, by = "prolific_pid") |>
  select(-c(comp_attempts, comp_passed)) |>
  left_join(demographics, by = "prolific_pid")

write_csv(data_clean_full, "../../data/data_clean_full.csv")

```

### Bonuses

```{r}
# participant bonus is balance at trial_index = 24, all should be 1.5

bonus_payment_full <- data_clean_full |>
  filter(trial == 24) |>
  select(prolific_pid, balance) 

cat(paste(bonus_payment_full$prolific_pid, bonus_payment_full$balance, sep = ","), sep = "\n")
  
```

## Slim (4 trials)

### Processing

```{r}
data_clean_slim <- data_raw |>
  group_by(prolific_pid) |>
  mutate(max_trial = max(trial_index)) |>
  ungroup() |>
  filter(max_trial <= 40) |>
  filter(trial_type != "instructions" & trial_type != "survey-multi-choice") |>
  select(prolific_pid, balance, choice, outcome, response, banner, win_status, hot_set_size, hot_numbers, outcome_rel_to_hot, trial_type, rt) |>
  group_by(prolific_pid) |>
  mutate(response = lead(response, 2)) |>
  ungroup() |>
  filter(!(is.na(balance) & is.na(hot_numbers))) |>
  filter(!(is.na(balance))) |>
  group_by(prolific_pid) |>
  mutate(trial = row_number()) |>
  ungroup() %>% 
  mutate(choice_hot = map2_lgl(choice, hot_numbers, ~ {
    hot_nums <- fromJSON(.y)
    .x %in% hot_nums
  })) %>%
  mutate(choice_hot = case_when(choice_hot == TRUE ~ "Chose Hot", TRUE ~ "Chose Non-Hot")) |>
  select(-c(trial_type, rt, hot_numbers)) %>% 
  mutate(
    response_parsed = map(response, ~ fromJSON(.x))
  ) %>%
  mutate(
    regret_chosen = map_dbl(response_parsed, ~ .x$regret_chosen %||% NA_real_),
    regret_notchosen_winner = map_dbl(response_parsed, ~ .x$regret_not_winner %||% NA_real_),
    regret_notchosen_hot_loser = map_dbl(response_parsed, ~ .x$regret_not_hot_probe %||% NA_real_)
  ) %>%
  select(-c(response, response_parsed)) |>
  rename(
    winner_number = outcome,
    chosen_number = choice,
    banner_yn = banner
  ) |>
  relocate(trial, .after = prolific_pid) |>
  mutate(
    win_status = ifelse(win_status == 0, "Lost", "Won"),
    banner_yn = ifelse(banner_yn == 0, "No Banner", "Banner")
  ) |>
  left_join(comp_attempts, by = "prolific_pid") |>
  select(-c(comp_attempts, comp_passed))|>
  left_join(demographics, by = "prolific_pid")

write_csv(data_clean_slim, "../../data/data_clean_slim.csv")
  
```

### Bonuses 
```{r}
# participant bonus is balance at trial_index = 4, all should be 0.42

bonus_payment_slim <- data_clean_slim |>
  filter(trial == 4) |>
  select(prolific_pid, balance) 

cat(paste(bonus_payment_slim$prolific_pid, bonus_payment_slim$balance, sep = ","), sep = "\n")
  
```

# Minecraft

## Full (24 trials)

### Processing

```{r}
data_clean_mc_full <- data_raw |>
  filter(prolific_study_id == "697191ef92bff03015a0bf86") |>
  group_by(prolific_pid) |>
  mutate(max_trial = max(trial_index)) |>
  ungroup() |>
  filter(max_trial >= 50) |>
  filter(trial_type != "instructions" & trial_type != "survey-multi-choice") |>
  select(prolific_pid, balance, choice, outcome, response, banner, win_status, hot_set_size, hot_numbers, outcome_rel_to_hot, trial_type, rt) |>
  group_by(prolific_pid) |>
  mutate(response = lead(response, 2)) |>
  ungroup() |>
  filter(!(is.na(balance) & is.na(hot_numbers))) |>
  filter(!(is.na(balance))) |>
  group_by(prolific_pid) |>
  mutate(trial = row_number()) |>
  ungroup() %>% 
  mutate(choice_hot = map2_lgl(choice, hot_numbers, ~ {
    hot_nums <- fromJSON(.y)
    .x %in% hot_nums
  })) %>%
  mutate(choice_hot = case_when(choice_hot == TRUE ~ "Chose Hot", TRUE ~ "Chose Non-Hot")) |>
  select(-c(trial_type, rt, hot_numbers)) %>% 
  mutate(
    response_parsed = map(response, ~ fromJSON(.x))
  ) %>%
  mutate(
    regret_chosen = map_dbl(response_parsed, ~ .x$regret_chosen %||% NA_real_),
    regret_notchosen_winner = map_dbl(response_parsed, ~ .x$regret_not_winner %||% NA_real_),
    regret_notchosen_hot_loser = map_dbl(response_parsed, ~ .x$regret_not_hot_probe %||% NA_real_)
  ) %>%
  select(-c(response, response_parsed)) |>
  rename(
    winner_number = outcome,
    chosen_number = choice,
    banner_yn = banner
  ) |>
  relocate(trial, .after = prolific_pid) |>
  mutate(
    win_status = ifelse(win_status == 0, "Lost", "Won"),
    banner_yn = ifelse(banner_yn == 0, "No Banner", "Banner")
  ) |>
  left_join(comp_attempts, by = "prolific_pid") |>
  select(-c(comp_attempts, comp_passed)) |>
  left_join(demographics, by = "prolific_pid")

write_csv(data_clean_mc_full, "../../data/data_clean_mc_full.csv")

```

### Bonuses

```{r}
# participant bonus is balance at trial_index = 24, all should be 1
bonus_payment_mc_full <- data_clean_mc_full |>
  filter(trial == 24) |>
  select(prolific_pid, balance) 

cat(paste(bonus_payment_mc_full$prolific_pid, bonus_payment_mc_full$balance, sep = ","), sep = "\n")
```


# Session Info
```{r}
# session info
sessionInfo() |>
  capture.output("processing_session_info.txt")
```
